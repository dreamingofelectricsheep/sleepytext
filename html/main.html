<html>
<head>
<title>Text</title>
<script type="text/javascript" src="graph.js"></script>
<script type="text/javascript">
window.onload = function() {
var body = document.getElementsByTagName('body')[0]

var editor = document.getElementById('editor')
editor.focus()

var last = ''
var queue = [], intransfer = []
var root = {
	time: new Date().getTime(),
	steps: []
	}
var branch = {
	length: 0,
	pieces: [ { piece: root } ],
}
	
var pointer = 0

editor.oninput = function(e) {
	var text = e.target.value
	var i = 0, j = 0


	for(; i < last.length; i++) {
		if(last[i] != text[i]) break; }

	for(; last.length - j> i + 1; j++) {
		if(last[last.length-j-1] != text[text.length-j-1]) break; }


	var ls = last.slice(i, last.length -j)
	var ts = text.slice(i, text.length -j)
	var change = {
		time: new Date().getTime(),
		pos: i,
		last: ls,
		now: ts }

	queue.push(change)
	branch.pieces[branch.pieces.length - 1].piece.steps.push(change)
	branch.length++
	pointer++

	last = text
}

var request = new XMLHttpRequest()
request.timeout = 5000
request.ontimeout = function() {
	alert("Timeout!")
}

request.onreadystatechange = function() {
	if(request.readyState != 4) return;
	if(request.status == 200) {
		intransfer = []
	}
	else alert("Transfer error, code: " + request.status)
}
	

function update() {
	if(intransfer.length == 0 && queue.length > 0) {
		intransfer = queue
		queue = []

		request.open('POST', '/feed')
		request.send(JSON.stringify(intransfer))
	}
}

setInterval(update, 1000)

var graphbutton = document.getElementById('graphbutton')
var graph = document.getElementById('graph')
graphbutton.onclick = function() {
	graph.classList.remove('hidden')
	var g = new Graph('graph', window.innerWidth, window.innerHeight)

	var all = historyconcat()

	for(var i = 0; i < all.length; ++i) {
		g.createVertex(all[i].time)	
		if(i > 0)
			g.createEdge(all[i].time,
				all[i - 1].time)	
	}

	g.go()
}

function historystep(change) {
	editor.value = editor.value.substr(0, change.pos) +
		change.now + editor.value.substr(change.pos + change.last.length,
			editor.value.length)
}
	
function historystepback(change) {
	editor.value = editor.value.substr(0, change.pos) +
		change.last + editor.value.substr(change.pos + change.now.length,
			editor.value.length)
}

function historyconcat() {
	var all = []
	for(var i in branch.pieces) {
		all = all.concat(branch.pieces[i].piece.steps.slice(0, branch.pieces[i].at))
	}
	return all
}

function historygo(go) {
	if(pointer == go) return;

	var all = historyconcat()
	for(var i in branch.pieces) {
		all = all.concat(branch.pieces[i].piece.steps.slice(0, branch.pieces[i].at))
	}

	while(pointer != go) {
		if(pointer > go) {
			historystepback(all[pointer-1])
			pointer--;
		}
		else {
			historystep(all[pointer])
			pointer++;
		}
	}	
		
}

var historyslider = document.getElementById('historyslider')
historyslider.oninput = function(e) {
	var go = Math.floor(historyslider.value / 10000 * branch.length)

	historygo(go)
}
	

}
</script>
<style type='text/css'>
body {
	margin: 0;
}

#editor {
	font: 20px serif normal;
	background-image: none;
	height: 100%;
	width: 100%;
	padding: 10px 20% 100px 20%;
	border: none;
	outline: none;
	resize: none;
	border-radius: 5px;
}
#graphbutton {
	cursor: pointer;
	position: fixed;
	font-family: sans-serif;
	font-size: 14px;
	right: 200px;
	bottom: 10px;
	line-height: 24px;
}
#graph {
	position: fixed;
	left: 0;
	top: 0;
	width: 1000px;
	height: 1000px;
	
}
.hidden {
	display: none;
}
#historyslider {
	position: fixed;
	bottom: 10px;
	left: 20%;
	width: 60%;
}
</style>
</head>
<body>
<textarea id="editor"></textarea>
<div id="graphbutton">history</div>
<input type="range" id="historyslider" min="0" max="10000" step="1" value="10000" />
<svg class="hidden" xmlns="http://www.w3.org/2000/svg" id="graph"></svg>
</div>
</body>
</html>
