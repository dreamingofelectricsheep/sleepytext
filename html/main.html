<html>
<head>
<title>Sleepy Text</title>
<script type="text/javascript" src="graph.js"></script>
<script type="text/javascript">
window.onload = function() {
var body = document.getElementsByTagName('body')[0]

var view;

function slider(parent, onchange) {
	this.parent = parent
	this.bar = document.createElement('div')
	this.bar.setAttribute('class', 'slider-bar')
	this.knob = document.createElement('div')

	var that = this

	this.knob.onmousedown = this.bar.onmousedown = function(e) {
		body.classList.add('unselectable')
		body.classList.add('clickable')

		var f = function(e) {
			var offset = e.clientX - that.bar.offsetLeft 

			var p = offset / that.bar.offsetWidth			
			that.to(p)
		}

		f(e)

		window.onmousemove = f 
		window.onmouseup = function() {
			body.classList.remove('unselectable')
			body.classList.remove('clickable')
	
			window.onmousemove = undefined
			window.onmouseup = undefined
		}
	}
			
	this.bar.appendChild(this.knob)
	parent.appendChild(this.bar)

	this.to(1)

	this.onchange = onchange
}

slider.prototype = {
	to: function(p, logic) {
		if(p < 0) p = 0
		if(p > 1) p = 1

		this.knob.style.left = 100 * p + '%'

		this.position = p

		if(this.onchange == undefined || logic == true) return
		this.onchange(this.position)
	},
	despawn: function() {
		this.parent.removeChild(this.bar)
	}
}

var queue = [], intransfer = []
var branches = []

function branch(past) {
	this.past = past
	this.present = []
	this.time = new Date().getTime()
	this.render = ''

	branches.push(this)
}

branch.prototype = {
	getlength: function() {
		var past = 0
		if(this.past) past = this.past.at
		return past + this.present.length 
	},
	gethistory: function() {
		var past = this.getprecedinghistory()
		return new history(past.concat(this.present))
	},
	getprecedinghistory: function() {
		var result = []

		if(this.past) {
			result = this.past.branch.getprecedinghistory()
			result = result.concat(this.past.branch.present.slice(0,
				this.past.at - result.length))
		}

		return result
	}
}

function history(steps) {
	this.steps = steps
	this.position = 0
	this.render = ''
}

history.prototype = {
	forward: function() {
		if(this.position > this.steps.length - 1) return

		var change = this.steps[this.position]
		this.position++

		this.render = this.render.substr(0, change.pos) +
			change.now + this.render.substr(change.pos + change.last.length,
				this.render.length)
	},
	
	back: function() {
		if(this.position <= 0) return;

		var change = this.steps[this.position - 1]
		this.position--;

		this.render = this.render.substr(0, change.pos) +
			change.last + this.render.substr(change.pos + change.now.length,
				this.render.length)
	},

	go: function(go) {
		if(this.position == go) return;
		if(go <= 0) go = 0
		if(go > this.steps.length) go = this.steps.length


		while(this.position != go)
			if(this.position > go) this.back()
			else this.forward()
		
	}
}



function entereditorview(activebranch) {
	view = {}
	view.editor = document.createElement("textarea")
	view.editor.setAttribute('autocomplete', 'off')
	view.editor.setAttribute('id', 'editor')


	view.graph = document.createElement('div')
	view.graph.setAttribute('id', 'graphbutton')
	view.graph.innerHTML = 'graph'

	view.branchbtn = document.createElement('div')
	view.branchbtn.setAttribute('id', 'branchbutton')
	view.branchbtn.innerHTML = 'branch'

	view.slider = new slider(body, function(p) {
		var go = Math.floor(p * view.history.steps.length)

		view.history.go(go)
		view.editor.last = view.editor.value = view.history.render
	})

	view.branch = activebranch == undefined ? new branch() : activebranch
	view.history = view.branch.gethistory()

	view.history.render = view.editor.last = view.editor.value = view.branch.render
	view.history.position = view.history.steps.length


	view.editor.oninput = function(e) {
		if(view.history.position != view.history.steps.length) {
			branchout()
		}

		var text = e.target.value
		var last = view.editor.last
		var i = 0, j = 0

		var min = Math.min(last.length, text.length)

		for(; i < min; i++) {
			if(last[i] != text[i]) break; }

		for(; min - j > i; j++) {
			if(last[last.length-j-1] != text[text.length-j-1]) break; }

		


		var ls = last.slice(i, last.length -j)
		var ts = text.slice(i, text.length -j)
		var change = {
			time: new Date().getTime(),
			pos: i,
			last: ls,
			now: ts }

		queue.push(change)
		view.branch.present.push(change)
		view.history.steps.push(change)
		view.history.position = view.history.steps.length

		view.history.render = view.branch.render = view.editor.last = text
	}
	
	function branchout() {
		var past = undefined;
		var i = view.branch

		var pointer = view.history.position
	
		
		while(true) {
			if(i.past == undefined) {
				past = { branch: i, at: pointer }
				break;
			}
			if(i.past.at > pointer) {
				i = i.past.branch
			} else {
				past = { branch: i, at: pointer }
				break;
			}
		}
		
		view.branch = new branch(past)
		view.history = view.branch.gethistory()
		view.history.position = view.history.steps.length

		view.slider.to(1, true)
	}


	view.branchbtn.onclick = function() {
		branchout()
	}

	view.graph.onclick = function() {
		var lastbranch = view.branch
		view.leave()
		entergraphview(lastbranch)
	}
	
	body.appendChild(view.editor)
	body.appendChild(view.graph)
	body.appendChild(view.branchbtn)

	view.editor.focus()

	view.leave = function() {
		var list = [view.editor, view.branchbtn, view.graph]
		for(var i in list)
			body.removeChild(list[i])

		view.slider.despawn()
		view = undefined
	}
}





function entergraphview(lastbranch) {
	view = {}
	var canvas = view.canvas = document.createElement('canvas')
	canvas.width = window.innerWidth
	canvas.height = window.innerHeight


	view.leave = function() {
		// Setting these makes a bug in chrome dissapear.
		// Otherwise there is a chance that the screen will not
		// refresh properly
		canvas.width = 0
		canvas.height = 0
		body.removeChild(canvas)
	}

	var g = new Graph(canvas, Math.floor(window.clientWidth * 3/5), '20px serif normal')

	var active = undefined
	var lastmouse = undefined

	window.onmousedown = function(e) {
		lastmouse = {
			x: e.clientX, y: e.clientY } }
			
	window.onmousemove = function(e) {
		if(lastmouse != undefined) {
			g.x -= lastmouse.x - e.clientX
			g.y -= lastmouse.y - e.clientY

			lastmouse = { x: e.clientX, y: e.clientY }
		}

		for(var i in g.vertices) {
			var v = g.vertices[i]
			if(Math.abs(g.x + v.x - e.clientX) < v.size && 
				Math.abs(g.y + v.y - e.clientY) < v.size) {
				body.classList.add('clickable')
				active = v
				return;
			}
		}

		active = undefined
		body.classList.remove('clickable')
	}

			 
	window.onmouseup = function() {
		lastmouse = undefined
		if(active == undefined) return

		window.onmouseup = undefined
		window.onmousemove = undefined
		window.onmousedown = undefined


		g.ending = {
			time: new Date().getTime(),
			vertex: active,
			callback: function() {

				lastbranch = active.branch
				pointer = undefined
	
				body.classList.remove('clickable')
				view.leave()
				entereditorview(lastbranch)

			}
		}
	}
	

	for(var i = 0; i < branches.length; ++i) {
		var color = undefined;
		if(branches[i].past == undefined) color = '#1987D1'

		var s = branches[i].present.length
		if(s < 1) s = 1
		s = 7 + Math.log(s) * 2

		
		var v = g.createVertex(branches[i].time, color, s, branches[i].render)

		if(branches[i].time == lastbranch.time)
			g.active = v

		v.branch = branches[i]	
	}
	

	for(var i = 0; i < branches.length; ++i) {
		if(branches[i].past)
			g.createEdge(branches[i].past.branch.time, branches[i].time)	
	}


	body.appendChild(canvas)
	g.go()
}


entereditorview()

var request = new XMLHttpRequest()
request.timeout = 5000
request.ontimeout = function() {
	alert("Timeout!")
}

function encode_int32(n) {
	var bytes = new Uint8Array(4)

	for(var i = 0; i < 4; i++)
		bytes[i] = (n >> (8*i)) % 256

	return bytes
}

function transferencode(list) {
	var pieces = []

	for(var i in list) {
		var c = list[i]

		var type = 'i'

		var utf8 = [c.last, c.now]
		for(var i in utf8) utf8[i] = new Blob([utf8[i]])

		var data = [c.pos, utf8[0].size, utf8[1].size]
		for(var i in data) data[i] = encode_int32(data[i])


		pieces = pieces.concat([type], utf8, data)
	}

	return new Blob(pieces)
}

request.onreadystatechange = function() {
	if(request.readyState != 4) return
	if(request.status != 200) {
		alert("Login failed!")
		return
	}
		


	request.onreadystatechange = function() {
		if(request.readyState != 4) return;
		if(request.status == 200) {
				intransfer = []
		}
		else alert("Transfer error, code: " + request.status)
	}
	

	function update() {
		if(intransfer.length == 0 && queue.length > 0) {
			intransfer = queue
			queue = []

			request.open('POST', '/feed')

			request.send(transferencode(intransfer))
			
		}
	}

	setInterval(update, 1000)

}

var user = localStorage.user

if(user == undefined) {
	request.open('POST', '/user')
	user = {
		login: Math.random() * 999999999999,
		password: Math.random() * 99999999999
	}

	request.send(user.login + '\n' + user.password)
	localStorage.user = JSON.stringify(user)
} else {
	user = JSON.parse(user)
	request.open('POST', '/login')
	
	request.send(user.login + '\n' + user.password)
}

}</script>
<style type='text/css'>
body {
	margin: 0;
}

.clickable {
	cursor: pointer;
}

.unselectable, .slider-bar, #graphbutton, #branchbutton {
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

#editor {
	font: 20px serif normal;
	background-image: none;
	height: 100%;
	width: 100%;
	padding: 10px 20% 100px 20%;
	border: none;
	outline: none;
	resize: none;
	border-radius: 5px;
}
#branchbutton, #graphbutton {
	color: white;
	cursor: pointer;
	position: fixed;
	font-family: sans-serif;
	font-size: 14px;
	bottom: 3px;
	line-height: 24px;
	background: blue;
	border-radius: 3px;
	padding: 1px 12px;
}
#branchbutton {
	right: 50px;
}
#graphbutton {
	right: 150px;
}
canvas {
	position: fixed;
	left: 0;
	top: 0;
}
.hidden {
	display: none;
}
.slider-bar {
	position: fixed;
	bottom: 10px;
	left: 20%;
	width: 60%;
	height: 4px;
	background: lightblue;
	cursor: hand;
}
.slider-bar div {
	margin-left: -8px;
	cursor: hand;
	position: relative;
	left: 0;
	top: -6px;
	height: 16px;
	width: 16px;
	border-radius: 100%;
	background: blue;
}
</style>
</head>
<body>
</body>
</html>
