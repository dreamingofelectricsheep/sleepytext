<html>
<head>
<title>Text</title>
<script type="text/javascript" src="graph.js"></script>
<script type="text/javascript">
window.onload = function() {
var body = document.getElementsByTagName('body')[0]

var editor = document.getElementById('editor')
editor.focus()

var last = ''
var queue = [], intransfer = []

var branches = []

function branch(past) {
	this.past = past
	this.present = []
	this.time = new Date().getTime()

	branches.push(this)
}

branch.prototype = {
	getlength: function() {
		var past = 0
		if(this.past) past = this.past.at
		return past + this.present.length 
	},
	gethistory: function() {
		var past = this.getprecedinghistory()
		return past.concat(this.present)
	},
	getprecedinghistory: function() {
		var result = []

		if(this.past) {
			result = this.past.branch.getprecedinghistory()
			result = result.concat(this.past.branch.present.slice(0,
				this.past.at - result.length))
		}

		return result
	}
}


var activebranch = new branch()	
var pointer = undefined

function branchout() {
		var past = undefined;
		var i = activebranch

		if(pointer == undefined) pointer = activebranch.getlength()
	
		
		while(true) {
			if(i.past == undefined) {
				past = { branch: i, at: pointer }
				break;
			}
			if(i.past.at > pointer) {
				i = i.past.branch
			} else {
				past = { branch: i, at: pointer }
				break;
			}
		}
		
		activebranch = new branch(past)
		pointer = undefined
		historyslider.value = 10000
}

editor.oninput = function(e) {
	if(pointer != undefined) {
		branchout()
	}

	var text = e.target.value
	var i = 0, j = 0

	var min = Math.min(last.length, text.length)

	for(; i < min; i++) {
		if(last[i] != text[i]) break; }

	for(; min - j > i; j++) {
		if(last[last.length-j-1] != text[text.length-j-1]) break; }

	


	var ls = last.slice(i, last.length -j)
	var ts = text.slice(i, text.length -j)
	var change = {
		time: new Date().getTime(),
		pos: i,
		last: ls,
		now: ts }

	queue.push(change)
	activebranch.present.push(change)

	last = text
}

var request = new XMLHttpRequest()
request.timeout = 5000
request.ontimeout = function() {
	alert("Timeout!")
}

request.onreadystatechange = function() {
	if(request.readyState != 4) return;
	if(request.status == 200) {
		intransfer = []
	}
	else alert("Transfer error, code: " + request.status)
}
	

function update() {
	if(intransfer.length == 0 && queue.length > 0) {
		intransfer = queue
		queue = []

		request.open('POST', '/feed')
		request.send(JSON.stringify(intransfer))
	}
}

setInterval(update, 1000)

var branchbutton = document.getElementById('branchbutton')

branchbutton.onclick = function() {
	branchout()
}


var graphbutton = document.getElementById('graphbutton')
var graph = document.getElementById('graph')

graphbutton.onclick = function() {
	graph.classList.remove('hidden')
	while(graph.firstChild)
		graph.removeChild(graph.firstChild)

	var g = new Graph('graph', window.innerWidth, window.innerHeight)


	for(var i = 0; i < branches.length; ++i) {
		var color = undefined;
		if(branches[i].time == activebranch.time) color = '#D1CE19'
		if(branches[i].past == undefined) color = '#1987D1'
		var v = g.createVertex(branches[i].time, color)
		v.branch = branches[i]	
		v.onclick = function() {
			last = ''
			editor.value = ''
			pointer = 0
			historyslider.value = 10000
			activebranch = this.branch
			historygo(activebranch.getlength())
			graph.classList.add('hidden')
			pointer = undefined
		}
	}

	for(var i = 0; i < branches.length; ++i) {
		if(branches[i].past)
			g.createEdge(branches[i].past.branch.time, branches[i].time)	
	}


	g.go()
}

function historystep(change) {
	editor.value = editor.value.substr(0, change.pos) +
		change.now + editor.value.substr(change.pos + change.last.length,
			editor.value.length)
}
	
function historystepback(change) {
	editor.value = editor.value.substr(0, change.pos) +
		change.last + editor.value.substr(change.pos + change.now.length,
			editor.value.length)
}

function historygo(go) {
	if(pointer != go) {

	var all = activebranch.gethistory()

	while(pointer != go) {
		if(pointer > go) {
			historystepback(all[pointer-1])
			pointer--;
		}
		else {
			historystep(all[pointer])
			pointer++;
		}
	}	
		
	}

	if(pointer == activebranch.getlength())
		pointer = undefined
}

var historyslider = document.getElementById('historyslider')

historyslider.oninput = function(e) {
	var go = Math.floor(historyslider.value / 10000 * activebranch.getlength())

	if(pointer == undefined) pointer = activebranch.getlength()
	historygo(go)
	last = editor.value
}
	

}
</script>
<style type='text/css'>
body {
	margin: 0;
}

#editor {
	font: 20px serif normal;
	background-image: none;
	height: 100%;
	width: 100%;
	padding: 10px 20% 100px 20%;
	border: none;
	outline: none;
	resize: none;
	border-radius: 5px;
}
#branchbutton {
	color: #9B8CCF;
	cursor: pointer;
	position: fixed;
	font-family: sans-serif;
	font-size: 14px;
	right: 100px;
	bottom: 10px;
	line-height: 24px;
}
#graphbutton {
	color: #9B8CCF;
	cursor: pointer;
	position: fixed;
	font-family: sans-serif;
	font-size: 14px;
	right: 200px;
	bottom: 10px;
	line-height: 24px;
}
#graph {
	position: fixed;
	left: 0;
	top: 0;
	width: 600px;
	height: 600px;
	background: white;
}
.hidden {
	display: none;
}
#historyslider {
	position: fixed;
	bottom: 10px;
	left: 20%;
	width: 60%;
}
</style>
</head>
<body>
<textarea id="editor"></textarea>
<div id="graphbutton">graph</div>
<div id="branchbutton">branch</div>
<input type="range" id="historyslider" min="0" max="10000" step="1" value="10000" />
<svg class="hidden" xmlns="http://www.w3.org/2000/svg" id="graph"></svg>
</div>
</body>
</html>
